#!/bin/bash

REPO_ROOT=$(git rev-parse --show-toplevel)

cd "$REPO_ROOT" || exit 1

echo "Running pre-push checks..."

if [ -d ".venv" ]; then
    source .venv/bin/activate
fi

echo "ğŸ” Running Ruff import sorting check..."
if ! ruff check . --select I --fix; then
    echo "âŒ Import sorting check failed. Push aborted."
    echo "Please review the changes and try again."
    exit 1
fi
echo "âœ… Import sorting check complete."

echo "ğŸ” Running Ruff format check..."
if ! ruff format --check .; then
    echo "Running automatic formatting..."
    ruff format .

    if ! git diff --quiet; then
        git add .
        git commit -m "style: auto-format code with Ruff"
        echo "âœ… Formatting changes have been automatically committed."
    fi
fi
echo "âœ… Code formatting check complete."

echo "ğŸ§ª Running tests..."
if ! .venv/bin/pytest tests/; then
    echo "âŒ Tests failed. Push aborted."
    echo "Please fix the failing tests before pushing."
    exit 1
fi

echo "âœ… All checks passed. Proceeding with push."
exit 0